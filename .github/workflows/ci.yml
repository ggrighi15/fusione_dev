name: FusionCore CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fail on forbidden runners
        shell: bash
        run: |
          set -euo pipefail
          echo "Scanning workflows for forbidden runners..."
          if grep -REn --line-number "^[[:space:]]*runs-on:[[:space:]]*.*self-hosted" .github/workflows; then
            echo "ERROR: self-hosted runner requested in workflow."
            exit 1
          fi
          if grep -REn --line-number "^[[:space:]]*runs-on:[[:space:]]*.*-xlarge" .github/workflows; then
            echo "ERROR: xlarge runner requested in workflow."
            exit 1
          fi
          if grep -REn --line-number "^[[:space:]]*runs-on:[[:space:]]*.*-large" .github/workflows; then
            echo "ERROR: large runner requested in workflow."
            exit 1
          fi
          echo "OK: no forbidden runners found."

  python-tests:
    runs-on: ubuntu-latest
    needs: guardrails
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pip dependency integrity
        run: pip check

      - name: Installer precheck
        run: python scripts/precheck_installers.py

      - name: Python syntax smoke
        run: |
          python -m py_compile scripts/map_automations.py
          python -m py_compile scripts/run_fiscal_normalization.py
          python -m py_compile scripts/precheck_installers.py
          python -m py_compile fc_circularizacao/src/init_db.py
          python -m py_compile fc_circularizacao/src/ingest_eml.py
          python -m py_compile fc_circularizacao/src/report_status.py

      - name: Circularizacao schema smoke
        run: test -f fc_circularizacao/data/schema.sql

  api-bootstrap-smoke-linux:
    runs-on: ubuntu-latest
    needs: guardrails
    env:
      DATABASE_URL: sqlite:///./test.db
      REDIS_URL: redis://localhost:6379/0
      SECRET_KEY: test_secret_key
      ENABLE_OCR_IA: "false"
      LLM_GATEWAY_ENABLED: "true"
      LLM_GATEWAY_MOCK_MODE: "true"
      LLM_REQUIRE_TRUSTED_IDENTITY: "false"
      LLM_ALLOW_BODY_IDENTITY_FALLBACK: "true"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip check

      - name: Apply SQL migrations
        run: python scripts/apply_db_migrations.py

      - name: API smoke (/health, /openapi, /llm/chat)
        shell: bash
        run: |
          set -euo pipefail
          python -m uvicorn fc_core.api.main:app --host 127.0.0.1 --port 8000 >/tmp/uvicorn.log 2>&1 &
          UVICORN_PID=$!
          trap 'kill $UVICORN_PID || true' EXIT

          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8000/health >/dev/null; then
              break
            fi
            sleep 1
          done

          curl -fsS http://127.0.0.1:8000/health
          curl -fsS http://127.0.0.1:8000/openapi.json >/dev/null

          cat > /tmp/llm_payload.json <<'JSON'
          {
            "prompt": "smoke test",
            "user_id": "ci-user",
            "team_id": "ci-team",
            "metadata": {"source": "ci-smoke"}
          }
          JSON
          curl -fsS -X POST http://127.0.0.1:8000/llm/chat \
            -H "Content-Type: application/json" \
            --data @/tmp/llm_payload.json >/dev/null

  dependency-install-smoke-windows:
    runs-on: windows-latest
    needs: guardrails
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies and verify imports
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip check
          @'
          import fastapi
          import uvicorn
          import PIL
          import pydantic_settings
          import celery
          import reportlab
          import aiofiles
          print("import smoke ok")
          '@ | python -

  ui-react-tests:
    runs-on: ubuntu-latest
    needs: guardrails
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run ui-react tests when app exists
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "apps/ui-react/package.json" ]; then
            echo "No apps/ui-react package.json found. Skipping UI tests."
            exit 0
          fi
          cd apps/ui-react
          if [ -f "pnpm-lock.yaml" ]; then
            corepack enable
            pnpm install --frozen-lockfile
            pnpm test --if-present
          elif [ -f "package-lock.json" ]; then
            npm ci
            npm test --if-present
          elif [ -f "yarn.lock" ]; then
            corepack enable
            yarn install --frozen-lockfile
            yarn test --if-present
          else
            npm install
            npm test --if-present
          fi
