<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Module - Fusione Core System</title>
    <link rel="icon" type="image/svg+xml" href="../logo-fusione.svg">
    
    <!-- CSS Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="../styles.css" rel="stylesheet">
    
    <style>
        .data-analysis-specific {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .data-analysis-card {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(4, 120, 87, 0.1) 100%);
            border: 1px solid rgba(5, 150, 105, 0.3);
        }
        
        .chart-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .chart-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chart-select {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .data-table th {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }
        
        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .data-source-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .data-source-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .data-source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .data-source-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .data-source-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-connected {
            background: var(--gradient-success);
            color: white;
        }
        
        .status-disconnected {
            background: var(--gradient-error);
            color: white;
        }
        
        .status-syncing {
            background: var(--gradient-warning);
            color: white;
        }
        
        .data-source-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .analysis-panel {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .analysis-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .control-input {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }
        
        .metric-icon {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .metric-change {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .metric-change.positive {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .metric-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .query-builder {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .query-editor {
            background: #1a1a1a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #f8f8f2;
            min-height: 120px;
            resize: vertical;
            width: 100%;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .export-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .visualization-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab-button {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header data-analysis-specific animate__animated animate__fadeInDown">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <h1 class="title">Data Analysis Module</h1>
                        <p class="subtitle">Análise Avançada de Dados e Business Intelligence</p>
                    </div>
                </div>
                <div class="system-status">
                    <div class="status-item">
                        <span class="status-value" id="totalRecords">-</span>
                        <span class="status-label">Registros</span>
                    </div>
                    <div class="status-item">
                        <span class="status-value" id="activeQueries">-</span>
                        <span class="status-label">Consultas</span>
                    </div>
                    <div class="status-item">
                        <span class="status-value" id="dataSourcesCount">-</span>
                        <span class="status-label">Fontes</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Key Metrics -->
        <section class="metric-grid animate__animated animate__fadeInUp">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-database"></i>
                </div>
                <span class="metric-value" id="totalDataVolume">0</span>
                <div class="metric-label">Volume de Dados (GB)</div>
                <div class="metric-change positive" id="dataVolumeChange">+0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <span class="metric-value" id="avgQueryTime">0</span>
                <div class="metric-label">Tempo Médio (ms)</div>
                <div class="metric-change positive" id="queryTimeChange">+0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <span class="metric-value" id="reportsGenerated">0</span>
                <div class="metric-label">Relatórios Gerados</div>
                <div class="metric-change positive" id="reportsChange">+0%</div>
            </div>
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-users"></i>
                </div>
                <span class="metric-value" id="activeUsers">0</span>
                <div class="metric-label">Usuários Ativos</div>
                <div class="metric-change positive" id="usersChange">+0%</div>
            </div>
        </section>

        <!-- Data Sources -->
        <section class="data-analysis-card animate__animated animate__fadeInUp">
            <h2 class="section-title">
                <i class="fas fa-plug"></i>
                Fontes de Dados
            </h2>
            <div id="dataSourcesList">
                <!-- Data sources will be loaded here -->
                <div class="loading">
                    <div class="spinner"></div>
                    Carregando fontes de dados...
                </div>
            </div>
        </section>

        <!-- Query Builder -->
        <section class="data-analysis-card animate__animated animate__fadeInUp">
            <h2 class="section-title">
                <i class="fas fa-code"></i>
                Construtor de Consultas
            </h2>
            <div class="query-builder">
                <div class="analysis-controls">
                    <div class="control-group">
                        <label class="control-label">Fonte de Dados</label>
                        <select class="control-input" id="queryDataSource">
                            <option value="">Selecione uma fonte</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Tipo de Análise</label>
                        <select class="control-input" id="analysisType">
                            <option value="select">Consulta SELECT</option>
                            <option value="aggregate">Agregação</option>
                            <option value="join">JOIN</option>
                            <option value="statistical">Análise Estatística</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Período</label>
                        <select class="control-input" id="timePeriod">
                            <option value="today">Hoje</option>
                            <option value="week">Última Semana</option>
                            <option value="month">Último Mês</option>
                            <option value="quarter">Último Trimestre</option>
                            <option value="year">Último Ano</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                </div>
                
                <textarea class="query-editor" id="queryEditor" placeholder="-- Digite sua consulta SQL aqui\nSELECT * FROM tabela WHERE condicao;"></textarea>
                
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="executeQuery()">
                        <i class="fas fa-play"></i>
                        Executar Consulta
                    </button>
                    <button class="btn btn-secondary" onclick="validateQuery()">
                        <i class="fas fa-check"></i>
                        Validar
                    </button>
                    <button class="btn btn-secondary" onclick="saveQuery()">
                        <i class="fas fa-save"></i>
                        Salvar
                    </button>
                    <button class="btn btn-secondary" onclick="clearQuery()">
                        <i class="fas fa-trash"></i>
                        Limpar
                    </button>
                </div>
            </div>
        </section>

        <!-- Visualization -->
        <section class="data-analysis-card animate__animated animate__fadeInUp">
            <h2 class="section-title">
                <i class="fas fa-chart-pie"></i>
                Visualização de Dados
            </h2>
            
            <div class="visualization-tabs">
                <button class="tab-button active" onclick="switchTab('chart')">
                    <i class="fas fa-chart-bar"></i>
                    Gráficos
                </button>
                <button class="tab-button" onclick="switchTab('table')">
                    <i class="fas fa-table"></i>
                    Tabela
                </button>
                <button class="tab-button" onclick="switchTab('pivot')">
                    <i class="fas fa-th"></i>
                    Tabela Dinâmica
                </button>
            </div>
            
            <div id="chartTab" class="tab-content active">
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">Análise de Tendências</div>
                        <div class="chart-controls">
                            <select class="chart-select" id="chartType">
                                <option value="line">Linha</option>
                                <option value="bar">Barras</option>
                                <option value="pie">Pizza</option>
                                <option value="scatter">Dispersão</option>
                                <option value="area">Área</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshChart()" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                    </div>
                    <canvas id="analysisChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <div id="tableTab" class="tab-content">
                <div style="overflow-x: auto;">
                    <table class="data-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>Carregando...</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Nenhum dado disponível</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="pivotTab" class="tab-content">
                <div class="analysis-panel">
                    <h3>Configuração da Tabela Dinâmica</h3>
                    <div class="analysis-controls">
                        <div class="control-group">
                            <label class="control-label">Linhas</label>
                            <select class="control-input" id="pivotRows" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Colunas</label>
                            <select class="control-input" id="pivotColumns" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Valores</label>
                            <select class="control-input" id="pivotValues" multiple>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Agregação</label>
                            <select class="control-input" id="pivotAggregation">
                                <option value="sum">Soma</option>
                                <option value="avg">Média</option>
                                <option value="count">Contagem</option>
                                <option value="min">Mínimo</option>
                                <option value="max">Máximo</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generatePivotTable()">
                        <i class="fas fa-table"></i>
                        Gerar Tabela Dinâmica
                    </button>
                </div>
                <div id="pivotTableContainer">
                    <!-- Pivot table will be generated here -->
                </div>
            </div>
            
            <div class="export-options">
                <button class="export-btn" onclick="exportData('excel')">
                    <i class="fas fa-file-excel"></i>
                    Excel
                </button>
                <button class="export-btn" onclick="exportData('csv')">
                    <i class="fas fa-file-csv"></i>
                    CSV
                </button>
                <button class="export-btn" onclick="exportData('pdf')">
                    <i class="fas fa-file-pdf"></i>
                    PDF
                </button>
                <button class="export-btn" onclick="exportData('json')">
                    <i class="fas fa-file-code"></i>
                    JSON
                </button>
            </div>
        </section>

        <!-- Action Buttons -->
        <section class="module-actions" style="display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="createNewAnalysis()">
                <i class="fas fa-plus"></i>
                Nova Análise
            </button>
            <button class="btn btn-secondary" onclick="scheduleReport()">
                <i class="fas fa-calendar"></i>
                Agendar Relatório
            </button>
            <button class="btn btn-secondary" onclick="manageDataSources()">
                <i class="fas fa-database"></i>
                Gerenciar Fontes
            </button>
            <button class="btn btn-secondary" onclick="viewSavedQueries()">
                <i class="fas fa-bookmark"></i>
                Consultas Salvas
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='../index.html'">
                <i class="fas fa-arrow-left"></i>
                Voltar ao Dashboard
            </button>
        </section>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Data Analysis Module specific functionality
        class DataAnalysisModuleInterface {
            constructor() {
                this.socket = io();
                this.dataSources = [];
                this.currentQuery = '';
                this.queryResults = [];
                this.chart = null;
                
                this.init();
            }
            
            init() {
                this.setupSocketListeners();
                this.loadModuleData();
                this.initializeChart();
                this.startMetricsUpdate();
            }
            
            setupSocketListeners() {
                this.socket.on('data-analysis-metrics', (data) => {
                    this.updateMetrics(data);
                });
                
                this.socket.on('query-result', (data) => {
                    this.handleQueryResult(data);
                });
                
                this.socket.on('data-source-update', (data) => {
                    this.handleDataSourceUpdate(data);
                });
            }
            
            async loadModuleData() {
                try {
                    const [dataSourcesResponse, metricsResponse] = await Promise.all([
                        fetch('/api/data-analysis-module/data-sources'),
                        fetch('/api/data-analysis-module/metrics')
                    ]);
                    
                    const dataSourcesData = await dataSourcesResponse.json();
                    const metricsData = await metricsResponse.json();
                    
                    this.dataSources = dataSourcesData.dataSources || [];
                    
                    this.updateMetrics(metricsData);
                    this.renderDataSources();
                    this.populateDataSourceSelects();
                } catch (error) {
                    console.error('Erro ao carregar dados do módulo Data Analysis:', error);
                    this.showError('Erro ao carregar dados');
                }
            }
            
            updateMetrics(metrics) {
                document.getElementById('totalRecords').textContent = (metrics.totalRecords || 0).toLocaleString();
                document.getElementById('activeQueries').textContent = metrics.activeQueries || 0;
                document.getElementById('dataSourcesCount').textContent = metrics.dataSourcesCount || 0;
                
                document.getElementById('totalDataVolume').textContent = (metrics.totalDataVolume || 0).toFixed(2);
                document.getElementById('avgQueryTime').textContent = metrics.avgQueryTime || 0;
                document.getElementById('reportsGenerated').textContent = (metrics.reportsGenerated || 0).toLocaleString();
                document.getElementById('activeUsers').textContent = metrics.activeUsers || 0;
                
                // Update change indicators
                this.updateChangeIndicator('dataVolumeChange', metrics.dataVolumeChange);
                this.updateChangeIndicator('queryTimeChange', metrics.queryTimeChange);
                this.updateChangeIndicator('reportsChange', metrics.reportsChange);
                this.updateChangeIndicator('usersChange', metrics.usersChange);
            }
            
            updateChangeIndicator(elementId, change) {
                const element = document.getElementById(elementId);
                if (element && change !== undefined) {
                    const isPositive = change >= 0;
                    element.textContent = (isPositive ? '+' : '') + change.toFixed(1) + '%';
                    element.className = 'metric-change ' + (isPositive ? 'positive' : 'negative');
                }
            }
            
            renderDataSources() {
                const container = document.getElementById('dataSourcesList');
                
                if (this.dataSources.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-database" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                            <h3>Nenhuma fonte de dados configurada</h3>
                            <p>Configure suas fontes de dados para começar a análise.</p>
                        </div>
                    `;
                    return;
                }
                
                const dataSourcesHTML = this.dataSources.map(source => this.createDataSourceHTML(source)).join('');
                container.innerHTML = dataSourcesHTML;
            }
            
            createDataSourceHTML(source) {
                const statusClass = this.getDataSourceStatusClass(source.status);
                
                return `
                    <div class="data-source-card" data-source-id="${source.id}">
                        <div class="data-source-header">
                            <div class="data-source-name">${source.name}</div>
                            <div class="data-source-status ${statusClass}">${source.status}</div>
                        </div>
                        
                        <div class="data-source-info">
                            <div class="info-item">
                                <div class="info-label">Tipo</div>
                                <div class="info-value">${source.type}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Registros</div>
                                <div class="info-value">${(source.recordCount || 0).toLocaleString()}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Última Sincronização</div>
                                <div class="info-value">${source.lastSync ? new Date(source.lastSync).toLocaleString('pt-BR') : 'Nunca'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Tamanho</div>
                                <div class="info-value">${this.formatFileSize(source.size || 0)}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary" onclick="testConnection('${source.id}')">
                                <i class="fas fa-plug"></i>
                                Testar Conexão
                            </button>
                            <button class="btn btn-secondary" onclick="syncDataSource('${source.id}')">
                                <i class="fas fa-sync"></i>
                                Sincronizar
                            </button>
                            <button class="btn btn-secondary" onclick="configureDataSource('${source.id}')">
                                <i class="fas fa-cog"></i>
                                Configurar
                            </button>
                        </div>
                    </div>
                `;
            }
            
            populateDataSourceSelects() {
                const selects = ['queryDataSource'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        // Clear existing options except first
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }
                        
                        // Add data source options
                        this.dataSources.forEach(source => {
                            const option = document.createElement('option');
                            option.value = source.id;
                            option.textContent = source.name;
                            select.appendChild(option);
                        });
                    }
                });
            }
            
            initializeChart() {
                const ctx = document.getElementById('analysisChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Dados',
                            data: [],
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e5e7eb'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#9ca3af'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
            
            async executeQuery() {
                const query = document.getElementById('queryEditor').value;
                const dataSource = document.getElementById('queryDataSource').value;
                
                if (!query.trim()) {
                    alert('Digite uma consulta SQL');
                    return;
                }
                
                if (!dataSource) {
                    alert('Selecione uma fonte de dados');
                    return;
                }
                
                try {
                    const response = await fetch('/api/data-analysis-module/execute-query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: query,
                            dataSource: dataSource
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.queryResults = result.data;
                        this.updateVisualization();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Erro ao executar consulta:', error);
                    alert('Erro ao executar consulta: ' + error.message);
                }
            }
            
            updateVisualization() {
                // Update table
                this.updateResultsTable();
                
                // Update chart
                this.updateChart();
            }
            
            updateResultsTable() {
                const table = document.getElementById('resultsTable');
                
                if (this.queryResults.length === 0) {
                    table.innerHTML = `
                        <thead><tr><th>Nenhum resultado</th></tr></thead>
                        <tbody><tr><td>A consulta não retornou dados</td></tr></tbody>
                    `;
                    return;
                }
                
                const columns = Object.keys(this.queryResults[0]);
                const headerHTML = columns.map(col => `<th>${col}</th>`).join('');
                const rowsHTML = this.queryResults.map(row => {
                    const cellsHTML = columns.map(col => `<td>${row[col] || ''}</td>`).join('');
                    return `<tr>${cellsHTML}</tr>`;
                }).join('');
                
                table.innerHTML = `
                    <thead><tr>${headerHTML}</tr></thead>
                    <tbody>${rowsHTML}</tbody>
                `;
            }
            
            updateChart() {
                if (this.queryResults.length === 0) return;
                
                const columns = Object.keys(this.queryResults[0]);
                const labelColumn = columns[0];
                const valueColumn = columns[1] || columns[0];
                
                const labels = this.queryResults.map(row => row[labelColumn]);
                const data = this.queryResults.map(row => parseFloat(row[valueColumn]) || 0);
                
                this.chart.data.labels = labels;
                this.chart.data.datasets[0].data = data;
                this.chart.data.datasets[0].label = valueColumn;
                this.chart.update();
            }
            
            // Utility methods
            getDataSourceStatusClass(status) {
                switch (status.toLowerCase()) {
                    case 'connected': case 'conectado': return 'status-connected';
                    case 'disconnected': case 'desconectado': return 'status-disconnected';
                    case 'syncing': case 'sincronizando': return 'status-syncing';
                    default: return 'status-disconnected';
                }
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            showError(message) {
                console.error(message);
            }
            
            startMetricsUpdate() {
                setInterval(() => {
                    if (!document.hidden) {
                        this.loadModuleData();
                    }
                }, 30000); // Update every 30 seconds
            }
        }
        
        // Global functions
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        function executeQuery() {
            dataAnalysisModule.executeQuery();
        }
        
        function validateQuery() {
            const query = document.getElementById('queryEditor').value;
            if (!query.trim()) {
                alert('Digite uma consulta SQL para validar');
                return;
            }
            
            // Basic SQL validation
            const keywords = ['SELECT', 'FROM', 'WHERE', 'GROUP BY', 'ORDER BY', 'HAVING'];
            const hasSelect = query.toUpperCase().includes('SELECT');
            const hasFrom = query.toUpperCase().includes('FROM');
            
            if (hasSelect && hasFrom) {
                alert('Consulta SQL válida!');
            } else {
                alert('Consulta SQL inválida. Verifique a sintaxe.');
            }
        }
        
        function saveQuery() {
            const query = document.getElementById('queryEditor').value;
            if (!query.trim()) {
                alert('Digite uma consulta SQL para salvar');
                return;
            }
            
            const name = prompt('Nome da consulta:');
            if (name) {
                // Save query logic here
                alert(`Consulta "${name}" salva com sucesso!`);
            }
        }
        
        function clearQuery() {
            document.getElementById('queryEditor').value = '';
        }
        
        function refreshChart() {
            dataAnalysisModule.updateChart();
        }
        
        function generatePivotTable() {
            alert('Funcionalidade de tabela dinâmica será implementada');
        }
        
        function exportData(format) {
            const url = `/api/data-analysis-module/export?format=${format}`;
            window.open(url, '_blank');
        }
        
        function testConnection(sourceId) {
            alert(`Testando conexão da fonte: ${sourceId}`);
        }
        
        function syncDataSource(sourceId) {
            alert(`Sincronizando fonte: ${sourceId}`);
        }
        
        function configureDataSource(sourceId) {
            alert(`Configurando fonte: ${sourceId}`);
        }
        
        function createNewAnalysis() {
            alert('Funcionalidade de nova análise será implementada');
        }
        
        function scheduleReport() {
            alert('Funcionalidade de agendamento será implementada');
        }
        
        function manageDataSources() {
            alert('Funcionalidade de gerenciamento de fontes será implementada');
        }
        
        function viewSavedQueries() {
            alert('Funcionalidade de consultas salvas será implementada');
        }
        
        // Initialize Data Analysis Module Interface
        let dataAnalysisModule;
        document.addEventListener('DOMContentLoaded', () => {
            dataAnalysisModule = new DataAnalysisModuleInterface();
        });
    </script>
</body>
</html>